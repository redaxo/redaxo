(function(c){function k(a,b,e){e=n(b,e);b=a.currentTarget;if("A"!==b.tagName.toUpperCase())throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(1<a.which||a.metaKey||a.ctrlKey))if(!(location.protocol!==b.protocol||location.host!==b.host)&&!(b.hash&&b.href.replace(b.hash,"")===location.href.replace(location.hash,"")))b={url:b.href,container:c(b).attr("data-pjax"),target:b,clickedElement:c(b),fragment:null},c.pjax(c.extend({},b,e)),a.preventDefault()}function o(a){var b=document.createElement("a");
b.href=a;return b}function n(a,b){a&&b?b.container=a:b=c.isPlainObject(a)?a:{container:a};b.container&&(b.container=p(b.container));return b}function p(a){a=c(a);if(a.length){if(""!==a.selector&&a.context===document)return a;if(a.attr("id"))return c("#"+a.attr("id"));throw"cant get selector for pjax container!";}throw"no pjax container for "+a.selector;}function q(a,b){var e=c();a.each(function(){c(this).is(b)&&(e=e.add(this));e=e.add(b,this)});return e}function r(a,b,e){var d={},b=(b.getResponseHeader("X-PJAX-URL")||
e.requestUrl).replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"");d.url=b;b=c(a);if(0===b.length)return d;d.title=q(b,"title").last().text();e.fragment?(a=q(b,e.fragment).first(),a.length&&(d.contents=a.contents(),d.title||(d.title=a.attr("title")||a.data("title")))):/<html/i.test(a)||(d.contents=b);d.contents&&(d.contents=d.contents.not("title"),d.contents.find("title").remove());d.title&&(d.title=c.trim(d.title));return d}function h(){this.mapping={};this.forwardStack=
[];this.backStack=[]}c.fn.pjax=function(a,b){return this.live("click.pjax",function(c){k(c,a,b)})};var f=c.pjax=function(a){function b(a,b){var d=c.Event(a,{relatedTarget:e});j.trigger(d,b);return!d.isDefaultPrevented()}a=c.extend(!0,{},c.ajaxSettings,f.defaults,a);c.isFunction(a.url)&&(a.url=a.url());var e=a.target;!e&&a.clickedElement&&(e=a.clickedElement[0]);var d=o(a.url).hash,h=a.beforeSend,s=a.complete,t=a.success,k=a.error,j=a.context=p(a.container);a.data||(a.data={});a.data._pjax=j.selector;
var l;a.beforeSend=function(c,d){if(d.timeout>0){l=setTimeout(function(){b("pjax:timeout",[c,a])&&c.abort("timeout")},d.timeout);d.timeout=0}c.setRequestHeader("X-PJAX","true");c.setRequestHeader("X-PJAX-Container",j.selector);var e;if(h){e=h.apply(this,arguments);if(e===false)return false}if(!b("pjax:beforeSend",[c,d]))return false;a.requestUrl=o(d.url).href};a.complete=function(c,d){l&&clearTimeout(l);s&&s.apply(this,arguments);b("pjax:complete",[c,d,a]);b("pjax:end",[c,a]);b("end.pjax",[c,a])};
a.error=function(c,d,e){var f=r("",c,a);k&&k.apply(this,arguments);var g=b("pjax:error",[c,d,e,a]);if(d!=="abort"&&g)window.location=f.url};a.success=function(e,g,h){var i=r(e,h,a);if(i.contents){f.state={id:a.id||(new Date).getTime(),url:i.url,title:i.title,container:j.selector,fragment:a.fragment,timeout:a.timeout};(a.push||a.replace)&&window.history.replaceState(f.state,i.title,i.url);if(i.title)document.title=i.title;j.html(i.contents);typeof a.scrollTo==="number"&&c(window).scrollTop(a.scrollTo);
(a.replace||a.push)&&window._gaq&&_gaq.push(["_trackPageview"]);if(d!=="")window.location.href=d;t&&t.apply(this,arguments);b("pjax:success",[e,g,h,a])}else window.location=i.url};f.state||(f.state={id:(new Date).getTime(),url:window.location.href,title:document.title,container:j.selector,fragment:a.fragment,timeout:a.timeout},window.history.replaceState(f.state,document.title));var g=f.xhr;g&&4>g.readyState&&(g.onreadystatechange=c.noop,g.abort());f.options=a;g=f.xhr=c.ajax(a);0<g.readyState&&(c(document).trigger("pjax",
[g,a]),a.push&&!a.replace&&(m.push(f.state.id,j.clone(!0,!0).contents()),window.history.pushState(null,"",a.url)),b("pjax:start",[g,a]),b("start.pjax",[g,a]),b("pjax:send",[g,a]));return f.xhr};f.reload=function(a,b){return c.pjax(c.extend({url:window.location.href,push:!1,replace:!0,scrollTo:!1},n(a,b)))};f.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20};h.prototype.push=function(a,b){this.mapping[a]=b;for(this.backStack.push(a);this.forwardStack.length;)delete this.mapping[this.forwardStack.shift()];
for(;this.backStack.length>f.defaults.maxCacheLength;)delete this.mapping[this.backStack.shift()]};h.prototype.get=function(a){return this.mapping[a]};h.prototype.forward=function(a,b){this.mapping[a]=b;this.backStack.push(a);(a=this.forwardStack.pop())&&delete this.mapping[a]};h.prototype.back=function(a,b){this.mapping[a]=b;this.forwardStack.push(a);(a=this.backStack.pop())&&delete this.mapping[a]};var m=new h;f.click=k;var u="state"in window.history,v=location.href;c(window).bind("popstate",function(a){var b=
!u&&location.href==v;u=!0;if(!b&&(a=a.state)&&a.container)if(b=c(a.container),b.length){var e=m.get(a.id);if(f.state){var d=f.state.id<a.id?"forward":"back";m[d](f.state.id,b.clone(!0,!0).contents())}d=c.Event("pjax:popstate",{state:a,direction:d});b.trigger(d);d={id:a.id,url:a.url,container:b,push:!1,fragment:a.fragment,timeout:a.timeout,scrollTo:!1};e?(c(document).trigger("pjax",[null,d]),b.trigger("pjax:start",[null,d]),b.trigger("start.pjax",[null,d]),a.title&&(document.title=a.title),b.html(e),
f.state=a,b.trigger("pjax:end",[null,d]),b.trigger("end.pjax",[null,d])):c.pjax(d);b[0].offsetHeight}else window.location=location.href});0>c.inArray("state",c.event.props)&&c.event.props.push("state");c.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);c.support.pjax||(c.pjax=function(a){var b=c.isFunction(a.url)?a.url():a.url,e=a.type?a.type.toUpperCase():"GET",d=c("<form>",{method:"GET"===
e?"GET":"POST",action:b,style:"display:none"});"GET"!==e&&"POST"!==e&&d.append(c("<input>",{type:"hidden",name:"_method",value:e.toLowerCase()}));a=a.data;if("string"===typeof a)c.each(a.split("&"),function(a,b){var e=b.split("=");d.append(c("<input>",{type:"hidden",name:e[0],value:e[1]}))});else if("object"===typeof a)for(key in a)d.append(c("<input>",{type:"hidden",name:key,value:a[key]}));c(document.body).append(d);d.submit()},c.pjax.click=c.noop,c.pjax.reload=window.location.reload,c.fn.pjax=
function(){return this})})(jQuery);
