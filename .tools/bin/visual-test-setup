#!/usr/bin/env bash

git ls-files -o | grep -v node_modules | grep -v ".idea" | grep -v "package.json" | grep -v "package-lock.json" | xargs rm
git restore .github/tests-visual/*.png

mysql -uroot -h127.0.0.1 -pmysql -e 'drop database redaxo5;'
mysql -uroot -h127.0.0.1 -pmysql -e 'create database redaxo5;'
php redaxo/bin/console setup:run -n --lang=de_de --db-host=127.0.0.1 --db-name=redaxo5 --db-password=mysql --db-createdb=no --db-setup=normal --admin-username=admin --admin-password=adminpassword --error-email=test@redaxo.invalid --ansi
php redaxo/bin/console config:set --type boolean debug.enabled true
php redaxo/bin/console config:set --type boolean debug.throw_always_exception true

php redaxo/bin/console user:create myusername mypassword --admin --ansi
php redaxo/bin/console config:set error_email 'test@redaxo.invalid' --ansi

mkdir -p redaxo/data/addons/backup && cp -r .github/imports/inital-content-for-visual-tests.sql redaxo/data/addons/backup/
cp -r .github/imports/media/* media/
cp -f .github/imports/README.md redaxo/src/addons/project/README.de.md
php redaxo/bin/console setup:run -n --lang=de_de --db-password=mysql --db-setup=import --db-import=inital-content-for-visual-tests --admin-username=myusername --admin-password=mypassword --ansi

php redaxo/bin/console package:install phpmailer --ansi
php redaxo/bin/console package:install cronjob --ansi
php redaxo/bin/console package:install cronjob/article_status --ansi
php redaxo/bin/console package:install cronjob/optimize_tables --ansi
php redaxo/bin/console package:install debug --ansi
php redaxo/bin/console package:install structure/history --ansi
php redaxo/bin/console package:install structure/version --ansi

npm install puppeteer@21 pixelmatch pngjs fs mkdirp


php redaxo/bin/console config:set setup true -t boolean --ansi
php redaxo/bin/console cache:clear --ansi
node .github/tests-visual/visual-record.js setup
php redaxo/bin/console config:set setup false -t boolean --ansi
php redaxo/bin/console cache:clear --ansi
node .github/tests-visual/visual-record.js
git diff --exit-code --name-only .github/tests-visual/
