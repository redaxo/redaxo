#!/usr/bin/env php
<?php

use Redaxo\Core\Filesystem\Dir;
use Redaxo\Core\Filesystem\File;
use Redaxo\Core\Filesystem\Finder;
use Redaxo\Core\Filesystem\Path;

require dirname(__DIR__) . '/bootstrap.php';

// avoid PREG_JIT_STACKLIMIT_ERROR, changelog parts can be long
ini_set('pcre.jit', 0);

/**
 * @internal
 */
class rex_release
{
    private static $addons = ['debug', 'install'];

    private $version;
    private $path;

    public function __construct($version)
    {
        $this->version = $version;
    }

    public function create()
    {
        $this->path = Path::base('releases/' . $this->version);
        if (file_exists($this->path)) {
            Dir::deleteFiles($this->path);
        }
        Dir::create($this->path);

        $this->updateVersions();

        if (!str_contains($this->version, '-')) {
            $this->setReleaseDate();
        }

        $this->createChangelog();

        $this->createArchives();
    }

    private function updateVersions()
    {
        $file = Path::core('boot.php');
        $content = File::get($file);
        $content = preg_replace('/(?<=^rex::setProperty\(\'version\', \').*?(?=\')/m', $this->version, $content);
        File::put($file, $content);

        $suffix = '';
        if (false !== $pos = strpos($this->version, '-')) {
            $suffix = substr($this->version, $pos);
        }

        $updateVersion = static function (rex_addon $package) use ($suffix) {
            $content = File::get($package->getPath(rex_addon::FILE_PACKAGE));
            $content = preg_replace('/^version: \'(.+?)-.*$/m', "version: '\\1$suffix'", $content);
            File::put($package->getPath(rex_addon::FILE_PACKAGE), $content);
        };

        foreach (self::$addons as $addon) {
            $addon = rex_addon::get($addon);
            $updateVersion($addon);
        }
    }

    private function setReleaseDate()
    {
        $date = date('d.m.Y');

        $updateDate = static function ($file) use ($date) {
            $content = File::get($file);
            $content = preg_replace('/XX\.[x\d]{2}\.[x\d]{4}/i', $date, $content);
            File::put($file, $content);
        };

        $updateDate(Path::core('CHANGELOG.md'));
        foreach (self::$addons as $addon) {
            $updateDate(Path::addon($addon, 'CHANGELOG.md'));
        }
    }

    private function createChangelog()
    {
        $cutNextPart = static function (&$changelog) {
            if (!preg_match('/^Version .*?([x\d]{2}\.[x\d]{2}\.[x\d]{4})(?:.|\v)*?(?=^Version \d|\z)/mi', $changelog, $match, PREG_OFFSET_CAPTURE)) {
                return null;
            }

            $changelog = substr($changelog, $match[0][1] + strlen($match[0][0]));

            return [
                'content' => rtrim($match[0][0]),
                'date' => false === stripos($match[1][0], 'x') ? strtotime($match[1][0]) : null,
            ];
        };

        $coreChangelog = File::get(Path::core('CHANGELOG.md'));
        $part = $cutNextPart($coreChangelog);
        $changelog = substr_replace($part['content'], 'REDAXO-Core', 0, 7);

        $previousDate = $cutNextPart($coreChangelog)['date'];

        foreach (self::$addons as $addon) {
            $addonChangelog = File::get(Path::addon($addon, 'CHANGELOG.md'));

            while (
                ($part = $cutNextPart($addonChangelog)) &&
                (!$part['date'] || $part['date'] > $previousDate)
            ) {
                $changelog .= "\n\n\n" . substr_replace($part['content'], $addon, 0, 7);
            }
        }

        $changelog .= "\n";

        File::put($this->path . '/CHANGELOG.md', $changelog);
    }

    private function createArchives()
    {
        $complete = new ZipArchive();
        $update = new ZipArchive();

        $complete->open($this->path . '/redaxo_' . $this->version . '.zip', ZipArchive::CREATE);
        $update->open($this->path . '/redaxo_update_' . $this->version . '.zip', ZipArchive::CREATE);

        $files = [
            'assets/.redaxo',
            'media/.redaxo',
            'redaxo/bin/.htaccess',
            'redaxo/bin/console',
            'redaxo/cache/.htaccess',
            'redaxo/cache/.redaxo',
            'redaxo/data/.htaccess',
            'redaxo/data/.redaxo',
            'redaxo/src/.htaccess',
            'redaxo/index.php',
            'index.php',
            'LICENSE.md',
            'README.md',
            'README.de.md',
            '.gitignore.example',
        ];

        foreach ($files as $file) {
            $complete->addFile(Path::base($file), $file);
        }

        $this->addDir($complete, Path::core(), 'redaxo/src/core');
        $this->addDir($update, Path::core(), 'core');

        foreach (self::$addons as $addon) {
            $this->addDir($complete, Path::addon($addon), 'redaxo/src/addons/' . $addon);
            $this->addDir($update, Path::addon($addon), 'addons/' . $addon);
        }
        $this->addDir($complete, Path::addon('project'), 'redaxo/src/addons/project');

        $this->addDir($complete, Path::core('assets'), 'assets/core');

        $files = require Path::core('vendor_files.php');
        foreach ($files as $source => $destination) {
            $complete->addFile(Path::core('assets_files/' . $source), 'assets/core/' . $destination);
        }

        $complete->close();
        $update->close();
    }

    private function addDir(ZipArchive $zip, $dir, $base)
    {
        $dir = rtrim($dir, '\\/');

        $finder = Finder::factory($dir)
            ->recursive()
            ->ignoreDirs('tests')
            ->filesOnly()
        ;

        foreach ($finder as $path => $file) {
            if (!$this->shouldIgnore($path)) {
                $zip->addFile($path, $base . substr($path, strlen($dir)));
            }
        }
    }

    private function shouldIgnore($path)
    {
        static $ignore;

        if (null === $ignore) {
            $ignore = file(Path::base('.gitignore'), FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
            $ignore = array_filter($ignore, static function ($path) {
                return '#' !== $path[0];
            });
        }

        $subpath = substr($path, strlen(Path::base()) - 1);
        foreach ($ignore as $pattern) {
            if (str_starts_with($subpath, $pattern)) {
                return true;
            }
        }

        return false;
    }
}

if (!isset($argv[1])) {
    exit('Missing version' . PHP_EOL);
}

$release = new rex_release($argv[1]);
$release->create();
